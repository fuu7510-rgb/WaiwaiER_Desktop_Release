# ハンドラと接続ロジックの仕様 (Current State)

ERエディタにおけるテーブル間の接続（リレーション）と、それを制御するハンドラの現在の実装仕様をまとめます。

## 1. ハンドラの構成

ハンドラは `reactflow` の `Handle` コンポーネントを使用しており、各テーブルノード（`TableNode.tsx`）内に配置されています。

### A. ソースハンドラ（Source / 出力）
- **ID形式**: `{columnId}__source`
- **配置**: カラムの**右側** (`Position.Right`)
- **表示条件**: カラムが「主キー (`isKey: true`)」である場合のみ表示
- **スタイル**: 
    - 背景色: アンバー (`!bg-amber-400`)
    - ボーダー: 白 (`!border-white`)
    - ホバー時: `!bg-amber-500`
    - カーソル: `cursor-crosshair`
- **役割**: このカラムを「参照先」とするリレーションの開始点。

### B. ターゲットハンドラ（Target / 入力 - 既存カラム）
- **ID形式**: `{columnId}`
- **配置**: カラムの**左側** (`Position.Left`)
- **表示条件**: 常時表示（ただし、後述の「リターゲットオーバーレイ」が表示されている間は非表示/無効化）
- **スタイル**:
    - 背景色: グレー (`!bg-zinc-400`)
    - ボーダー: 白 (`!border-white`)
- **役割**: このカラムを `Ref` 型に変更し、ソースカラムを参照させる。

### C. ターゲットハンドラ（Target / 入力 - カラム追加）
- **ID形式**: `{tableId}__addColumn`
- **配置**: テーブル最下部の「+カラムを追加」ボタンの**左側**
- **表示条件**: 常時表示
- **スタイル**:
    - 背景色: グリーン (`!bg-green-400`)
    - ボーダー: 白 (`!border-white`)
- **役割**: 接続すると、ターゲットテーブルに新しいカラムを自動生成し、それを `Ref` 型としてソースカラムに接続する。

---

## 2. 接続ロジック (`EREditor.tsx`)

接続の有効性は `isValidConnection` で判定され、実際の処理は `onConnect` で行われます。

### 有効な接続の条件
- **ソース**: 必ず `isKey: true` のカラムであること（IDの末尾が `__source` であることで識別）。
- **ターゲット**: 既存のカラム、または「カラム追加」ハンドラであること。
- **制限事項**:
    - すでに他から参照されている（入力リレーションがある）カラムへの接続は不可。
    - 同一のカラムペア間での重複したリレーション作成は不可。

### 接続時の動作 (`onConnect`)
- **既存カラムに接続した場合**:
    1. そのカラムの型を `Ref` に変更。
    2. `constraints.refTableId` と `refColumnId` をソースの情報で更新。
    3. `relations` ストアに新しいリレーションを追加。
- **「カラム追加」に接続した場合**:
    1. ターゲットテーブルに、ソースカラム名と同じ名前の新しいカラムを作成。
    2. 作成したカラムを `Ref` 型に設定。
    3. `relations` ストアに新しいリレーションを追加。

---

## 3. 特殊な操作

### リターゲットオーバーレイ (Retarget Overlay)
既存の入力リレーションがあるカラムでは、通常のグレーのハンドラの代わりに**プライマリカラー（青紫）**の円が表示されます。

- **表示条件**: `hasIncomingRelation` が `true` のカラム。
- **挙動**: 
    - この円は「既にリレーションが存在する」ことを示すインジケータです。
    - **ドラッグ不可**: この円を直接ドラッグして付け替える機能は廃止されました。リレーションの付け替えは後述の「エッジの端（Edge Updater）」を使用してください。

### エッジの端（Edge Updater / 付け替えハンドル）
既存の「線（エッジ）」の端をドラッグして、別のカラムへリレーションを繋ぎ変える機能です。**リレーションの付け替え（リターゲット）を行う唯一の方法です。**

- **外観**: エッジの両端に配置される透明な円。マウスを近づけると操作可能になります。
    - React Flow内部クラス: `.react-flow__edgeupdater`
- 反応半径: 4px (`edgeUpdaterRadius={4}`)
- **挙動 (`onEdgeUpdate`)**:
    - 端をドラッグして他の有効なハンドラ（カラム）にドロップすると、リレーションが更新されます。
    - **ターゲット側（参照元）の付け替え**:
        - 新しいターゲットが「カラム追加」ハンドラの場合、新規カラムを自動作成して接続します。
        - 既存のカラムにドロップした場合、そのカラムを `Ref` に変更して接続します。
        - **重要**: 付け替え前の「旧ターゲットカラム」が `Ref` 型だった場合、そのリレーションが解消されるため、自動的に `Text` 型へリセットされます。
    - **ソース側（参照先）の付け替え**:
        - 参照先のテーブルや主キーカラムを変更できます。
- **失敗時の動作**: 有効なハンドラ以外（何もない場所など）で離した場合、そのリレーションは削除（`detachRelation`）されます。

---

## 4. 視覚的フィードバック

- **禁止マーク**: 接続ドラッグ中に `isValidConnection` が `false` を返す場所（自分自身や既に参照されているカラムなど）にカーソルを合わせると、カーソルの横に「×」マークが表示されます。
- **フラッシュ**: 無効な場所にドロップしようとした際、その場所に一時的に「×」マークがフラッシュ表示されます。

