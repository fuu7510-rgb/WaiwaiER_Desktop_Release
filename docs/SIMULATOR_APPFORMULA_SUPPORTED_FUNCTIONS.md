# Simulator: AppFormula 対応範囲（暫定）

作成日: 2025-12-27

このドキュメントは WaiwaiER Desktop の Simulator で再現している AppSheet の AppFormula（アプリ数式）の対応範囲をまとめたものです。

## 前提

- AppFormula は **Simulator表示用の計算列**として扱います。
  - 行データ（sample data）へは保存しません。
  - 編集モードでも AppFormula 列は入力欄を出さず、表示のみです。
- 評価コンテキスト
  - 通常の `[列名]` は「その行（row）」を参照します。
  - `[_THISROW]` は SELECT/FILTER の条件式評価中に、**外側の行**を参照します。

## 旧データ互換（重要）

旧プロジェクトや手入力の癖に合わせて、Simulator側では以下を「許容」します。

- 式の先頭の `=` を無視（例: `=[数量] * [価格]` でも評価）
- 全角の演算子を正規化して評価
  - `×` / `＊` → `*`、`＋` → `+`、`－` → `-`、`／` → `/`、`＝` → `=` など
- `-` / `—` / `−` を空欄扱い（旧サンプルデータでありがちな表現）

## 構文

- 列参照: `[列名]`
- Refドット参照: `[Ref列].[参照先列名]`
- テーブル列参照（SELECT用）: `TableName[ColumnName]`
- 文字列: `"..."`
- リテラル: `TRUE`, `FALSE`, `BLANK`

## 演算子

- 連結: `&`
- 四則: `+`, `-`, `*`, `/`
- 比較: `=`, `<>`, `<`, `>`, `<=`, `>=`

## 関数（対応）

- `IF(condition, then, else)`
- `AND(a, b, ...)`
- `OR(a, b, ...)`
- `NOT(x)`
- `ISBLANK(x)`
- `CONCATENATE(a, b, ...)`
- `TEXT(x)`
- `TODAY()`
- `NOW()`

### 他テーブル参照・集計系（今回追加）

- `LOOKUP(key, "Table", "KeyColumn", "ReturnColumn")`
  - 返り値: スカラー（見つからなければ空）

- `FILTER("Table", condition)`
  - 返り値: **キー値のリスト**（見つからなければ空リスト）

- `SELECT(Table[Column], condition)`
  - 返り値: **値のリスト**（見つからなければ空リスト）

- `ANY(list)`
  - 返り値: リストの先頭要素（空なら空）

## 注意点（AppSheetとの差）

- リスト値は内部的には配列で保持しますが、画面表示上は文字列化される場合があります（例: `a, b, c`）。
- AppSheetのすべての型/関数/厳密な評価規則を完全再現しているわけではありません。
- 未対応の関数は fail-soft で空を返します。

## 例: シンプルな参照（ご要望）

式:

- `[小計] * [ID商品].[価格]`

前提（重要）:

- `ID商品` は **型が `Ref`** の列で、参照先テーブル（例: `商品`）が設定されていること
- 参照先テーブル（例: `商品`）に `価格` 列が存在し、行データに値が入っていること
- 参照は **列名で解決**するため、式内の `ID商品` / `価格` はERエディタ上の列名と一致させること

## よくあるつまずき: 計算結果が空になる

次のケースでは計算結果が空（表示されない）になります。

- 参照している列が空欄
  - 例: `小計` 列が空のまま `=[価格] * [小計]` とすると、結果も空になります
- 数値として解釈できない文字列が入っている
  - 例: `2,000` のようにカンマ入りだと、数値化できず空になります

0扱いしたい場合は明示的に書きます:

- `IF(ISBLANK([価格]), 0, [価格]) * IF(ISBLANK([小計]), 0, [小計])`

## 典型例: 注文詳細（行）

スクショのように「注文詳細」テーブルに `数量` と `価格` と `ID商品(Ref)` がある場合の例です。

- 単価（価格）を商品マスタから引く: `[ID商品].[価格]`
- 小計を計算する: `[数量] * [価格]`

※ `価格` が商品側の列で、注文詳細側に同名列が無い場合は、`[価格]` では取れません。必ず `[ID商品].[価格]` を使います。
