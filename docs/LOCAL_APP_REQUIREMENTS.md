# 要件定義書: ローカルER図エディタアプリ（デスクトップ版）

**作成日**: 2025-12-19  
**更新日**: 2025-12-23  
**ステータス**: 確定版 v1.0

---

## 1. 概要

### 1.1 目的
既存のWeb共同編集アプリ「WaiwaiER」を参照しつつ、**完全に新規のリポジトリ**でオフライン動作するデスクトップアプリケーションを開発する。

### 1.2 アプリケーション名（仮）
**WaiwaiER Desktop** （または適切な名称を後日決定）

### 1.3 コンセプト
- **オフラインファースト**: ネットワーク不要で全機能が動作
- **軽量・高速**: ローカルDB使用で即時レスポンス
- **サブスクリプション対応**: 有料/無料プランの切り替え機能
- **セキュリティ**: ユーザー選択によるプロジェクト単位の暗号化

---

## 2. 対象プラットフォーム

| プラットフォーム | サポート状況 | 配布形式 |
|-----------------|-------------|---------|
| **Windows** | ✅ 必須 | Microsoft Store（MSIX）/ EXE インストーラー |
| macOS | 🔲 将来検討 | DMG / PKG |
| Linux | 🔲 将来検討 | AppImage / deb / rpm |

---

## 3. 前提条件（確定事項）

| 項目 | 決定内容 |
|-----|---------|
| サーバ | 常設サーバは使用しない（完全オフライン） |
| 認証 | **ローカル認証のみ**（オフラインライセンス検証） |
| 課金 | サブスクリプション方式（有料/無料プラン） |
| データ保存 | ローカルDB（SQLite推奨） |
| 暗号化 | ユーザー選択可能（プロジェクト単位） |

---

## 4. 機能要件

### 4.1 MVP（最小実行可能製品）機能

#### 4.1.1 コア機能（既存Webアプリから継承）

| 機能 | 説明 | 優先度 |
|-----|------|--------|
| **ビジュアルERエディタ** | テーブル追加・編集・削除、カラム定義、ドラッグ&ドロップ配置 | 必須 |
| **リレーション管理** | 線によるテーブル間接続、Ref型自動設定 | 必須 |
| **Undo/Redo** | Ctrl+Z/Y による操作履歴管理 | 必須 |
| **テーブルコピー&同期** | 同期グループによるスキーマ同期 | 必須 |
| **シミュレーター** | テーブル/デッキ/詳細/フォームビュー | 必須 |
| **サンプルデータ生成** | Faker.jsによる日本語サンプルデータ | 必須 |
| **インポート/エクスポート（JSON）** | ER図のJSON形式保存・復元 | 必須 |
| **Excelエクスポート** | .xlsx形式でエクスポート（Googleスプレッドシート連携用） | 必須 |

#### 4.1.2 新規機能（ローカルアプリ専用）

| 機能 | 説明 | 優先度 |
|-----|------|--------|
| **プロジェクト管理** | 複数プロジェクトの作成・切替・削除 | 必須 |
| **ローカル永続化** | SQLiteによるデータ永続化 | 必須 |
| **自動バックアップ** | 定期的なローカルバックアップ | 必須 |
| **プロジェクト暗号化** | プロジェクト単位での暗号化（オプション） | 必須 |
| **ライセンス管理** | 有料/無料プランの管理 | 必須 |
| **エクスポートパッケージ** | ZIPパッケージによるデータ移行 | 必須 |

### 4.2 UI再利用方針

既存のReact + TypeScript コンポーネントを最大限再利用する：

```
再利用対象コンポーネント:
├── EREditor/          # ER図エディタ全体
│   ├── EREditor.tsx
│   ├── TableNode.tsx
│   ├── ConfirmDialog.tsx
│   └── ...
├── Simulator/         # AppSheetシミュレーター
├── hooks/             # カスタムフック
├── stores/            # Zustandストア（erStore.ts）
└── types/             # 型定義
```

**除外・置き換え対象**:
- `Auth/` → ローカルライセンス管理に置き換え
- `projects/` → ローカルプロジェクト管理に再実装
- Liveblocks関連 → 削除
- Supabase関連 → SQLiteに置き換え

---

## 5. サブスクリプション・課金システム

### 5.1 プラン構成

| プラン | 月額（税込） | 機能制限 |
|-------|------------|---------|
| **Free** | ¥0 | プロジェクト数: 3個まで、テーブル数: 5個/プロジェクト |
| **Pro** | ¥300 | 無制限 + 優先サポート |

> **Note**: Teamプラン（チームライセンス）は将来対応として検討

### 5.2 オフラインライセンス認証方式

オフライン環境でのサブスクリプション管理には以下の方式を推奨：

#### 方式A: ライセンスキー方式（推奨）

```
┌─────────────────────────────────────────────────────────────┐
│                    ライセンス認証フロー                       │
├─────────────────────────────────────────────────────────────┤
│  1. ユーザーがWebサイトでサブスク購入                          │
│  2. ライセンスキー発行（署名付きJWT形式）                      │
│  3. アプリにライセンスキーを入力                              │
│  4. アプリがローカルで署名検証（公開鍵埋め込み）               │
│  5. 有効期限をローカルに保存                                  │
│  6. 定期的なオンライン検証（接続可能時のみ）                   │
└─────────────────────────────────────────────────────────────┘
```

#### 実装詳細

| 項目 | 仕様 |
|-----|------|
| ライセンス形式 | 署名付きJWT（RS256） |
| 含まれる情報 | ユーザーID, プラン, 有効期限, マシンID（オプション） |
| 検証方式 | 公開鍵をアプリに埋め込み、ローカルで検証 |
| 猶予期間 | オフライン継続使用可能期間: 30日間 |
| 更新チェック | ネットワーク接続時に自動更新確認 |

#### 課金プラットフォーム

**LemonSqueezy** を採用

| 項目 | 内容 |
|-----|------|
| プラットフォーム | LemonSqueezy |
| 手数料 | 5-8% |
| 特徴 | SaaS向け、税金計算・請求書発行自動化、個人開発者に最適 |

### 5.3 猶予期間とオフライン対応

```
オフライン猶予期間の動作:
─────────────────────────────────────────────────────
Day 0    : ライセンス検証成功（オンライン）
Day 1-30 : オフラインでも全機能使用可能
Day 31   : 警告表示「オンライン検証が必要です」
Day 37   : 機能制限開始（Free版相当に制限）
Day 45+  : 読み取り専用モード（データ保護優先）
─────────────────────────────────────────────────────
```

---

## 6. セキュリティ要件

### 6.1 暗号化アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    暗号化レイヤー構成                         │
├─────────────────────────────────────────────────────────────┤
│  Layer 1: パスフレーズ入力                                   │
│      ↓                                                       │
│  Layer 2: 鍵導出（Argon2id推奨 / PBKDF2フォールバック）       │
│      ↓                                                       │
│  Layer 3: データ暗号化キー（DEK）生成                        │
│      ↓                                                       │
│  Layer 4: SQLCipher（DBレベル暗号化）                        │
│           + AES-256-GCM（エクスポートファイル暗号化）         │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 プロジェクト単位の暗号化

| 項目 | 仕様 |
|-----|------|
| 暗号化単位 | **プロジェクトごと** |
| 暗号化DB | SQLCipher（SQLite拡張） |
| 鍵導出 | Argon2id（メモリ64MB, 反復3回, 並列4） |
| ファイル暗号化 | AES-256-GCM |
| キー保存オプション | OSキーチェーン（Keychain/Credential Manager） |

### 6.3 暗号化設定フロー

#### 初回起動時

```
┌────────────────────────────────────────┐
│   🔐 セキュリティ設定                    │
├────────────────────────────────────────┤
│  データの暗号化を有効にしますか？          │
│                                          │
│  ✅ 暗号化を有効にする（推奨）            │
│  ○ 暗号化を使用しない                    │
│                                          │
│  [詳細を表示]                            │
│                                          │
│  ⚠️ 暗号化を有効にする場合、              │
│  パスフレーズを忘れるとデータを            │
│  復元できなくなります。                   │
│                                          │
│           [次へ]  [スキップ]              │
└────────────────────────────────────────┘
```

#### プロジェクト作成時

```
┌────────────────────────────────────────┐
│   📁 新規プロジェクト作成                 │
├────────────────────────────────────────┤
│  プロジェクト名: [________________]       │
│                                          │
│  🔐 このプロジェクトを暗号化する           │
│     ☑ 有効（推奨）                       │
│                                          │
│  パスフレーズ: [________________]         │
│  確認:        [________________]         │
│                                          │
│  ☐ OSキーチェーンに保存する               │
│                                          │
│           [作成]  [キャンセル]            │
└────────────────────────────────────────┘
```

### 6.4 暗号化移行フロー

#### 平文 → 暗号化

1. プロジェクト設定画面で「暗号化を有効にする」を選択
2. 警告ダイアログ表示：
   - 「パスフレーズを忘れるとデータを復元できません」
   - 「バックアップを取ることを推奨します」
3. パスフレーズ設定（確認入力あり）
4. バックグラウンドで暗号化処理実行
5. 完了通知

#### 暗号化 → 平文（解除）

1. プロジェクト設定画面で「暗号化を解除する」を選択
2. 現在のパスフレーズを入力
3. 警告ダイアログ表示：
   - 「データが平文で保存されます」
   - 「セキュリティリスクを理解しました」のチェックボックス
4. バックグラウンドで復号処理実行
5. 完了通知

### 6.5 将来的なE2EE拡張ポイント

```
将来拡張設計:
─────────────────────────────────────────────────────
1. 鍵管理インターフェースの抽象化
   - LocalKeyProvider（現行）
   - CloudKeyProvider（将来: キー同期）
   - HardwareKeyProvider（将来: YubiKey等）

2. エクスポートパッケージのE2EE対応
   - 受信者の公開鍵で暗号化
   - 複数受信者への共有対応

3. 監査ログの暗号化署名
   - 改ざん検知
   - タイムスタンプ証明
─────────────────────────────────────────────────────
```

---

## 7. 非機能要件

### 7.1 パフォーマンス

| 項目 | 目標値 |
|-----|--------|
| アプリ起動時間 | < 3秒 |
| 操作レスポンス | < 100ms（ローカル操作） |
| 大規模プロジェクト | 100テーブル / 1000カラム でも快適動作 |
| メモリ使用量 | < 500MB（通常使用時） |

### 7.2 信頼性・バックアップ

| 機能 | 仕様 |
|-----|------|
| 自動バックアップ | 5分ごと + 終了時 |
| バックアップ保持 | 直近10世代 + 日次7日分 |
| バックアップ場所 | ユーザー指定可能（デフォルト: ドキュメントフォルダ） |
| 復元機能 | バックアップ一覧から選択して復元 |
| クラッシュリカバリ | 未保存データの自動回復 |

### 7.3 可搬性・データ移行

| 機能 | 仕様 |
|-----|------|
| エクスポート形式 | ZIPパッケージ（.waiwai） |
| パッケージ内容 | metadata.json + project.db + attachments/ |
| インポート | ドラッグ&ドロップまたはファイル選択 |
| 暗号化パッケージ | パスフレーズ入力でインポート |

### 7.4 ローカライズ

| 言語 | ステータス |
|-----|----------|
| 日本語 | ✅ 必須（デフォルト） |
| 英語 | ✅ 必須 |

**実装方式**: i18next または react-intl

### 7.5 Googleスプレッドシート連携機能

#### 基本方針

| 項目 | 内容 |
|-----|------|
| 方式 | Google API (OAuth) を使用せず、ローカルで .xlsx ファイルを生成 |
| 運用フロー | ユーザーが生成した .xlsx をGoogleドライブへ手動アップロード |
| 理由 | OAuth導入コストの回避、オフライン動作の維持 |

#### 技術仕様

| 項目 | 仕様 |
|-----|------|
| 実装箇所 | Tauri (Rust) バックエンド |
| ライブラリ | **rust_xlsxwriter** |
| 出力形式 | .xlsx（Excel 2007以降形式） |

#### 【重要】メモ項目の実装仕様

Googleスプレッドシートの「メモ (Note)」として正しくインポートさせるため、特別な実装が必要：

| 項目 | 仕様 |
|-----|------|
| 要件 | 「スレッド形式コメント」ではなく「レガシーなメモ」として作成 |
| 使用メソッド | `write_note` **（write_comment は使用しない）** |
| 理由 | Googleスプレッドシートは `write_comment` で作成されたスレッド形式コメントを正しくインポートできない |

```rust
// ✅ 正しい実装（Googleスプレッドシート互換）
worksheet.write_note(row, col, "メモの内容")?;

// ❌ 使用禁止（Googleスプレッドシートで正しくインポートされない）
// worksheet.write_comment(row, col, &comment)?;
```

#### 出力内容

| シート | 内容 |
|-------|------|
| テーブルごとのシート | 各テーブルのデータ（ヘッダー + サンプルデータ） |
| ヘッダーセルのメモ | カラム設定情報（データ型、制約など） |

#### ユーザーフロー

```
1. アプリでER図を編集
2. 「Excelエクスポート」ボタンをクリック
3. .xlsx ファイルがローカルに保存される
4. ユーザーがGoogleドライブにアップロード
5. Googleスプレッドシートとして開く（メモが正しく表示される）
```

---

## 8. 技術スタック（推奨）

### 8.1 アプリケーションフレームワーク

| レイヤー | 技術 | 理由 |
|---------|-----|------|
| ネイティブラッパー | **Tauri 2.x** | 軽量、Rust製、セキュア |
| フロントエンド | **React 18 + TypeScript** | 既存資産の再利用 |
| ビルドツール | **Vite** | 高速、既存設定流用可能 |
| 状態管理 | **Zustand** | 既存のerStore.ts継続使用 |
| UIフレームワーク | **Tailwind CSS** | 既存スタイル再利用 |

### 8.2 データ層

| 機能 | 技術 | 備考 |
|-----|-----|------|
| ローカルDB | **SQLite** (better-sqlite3 or sql.js) | Tauriでは tauri-plugin-sql |
| 暗号化DB | **SQLCipher** | SQLite互換、透過的暗号化 |
| マイグレーション | **Drizzle ORM** または 自前スクリプト | |
| Excelエクスポート | **rust_xlsxwriter** (Rust) | Googleスプレッドシート連携用 |

### 8.3 セキュリティ

| 機能 | ライブラリ |
|-----|----------|
| 鍵導出 | argon2 (WebAssembly) |
| ファイル暗号化 | libsodium.js / Web Crypto API |
| キーチェーン | Tauri keyring plugin |

### 8.4 プロジェクト構成（単一パッケージ）

```
waiwai-desktop/
├── package.json
├── vite.config.ts
├── tsconfig.json
├── src-tauri/             # Rustバックエンド
│   ├── Cargo.toml
│   ├── tauri.conf.json
│   └── src/
│       └── main.rs
├── src/                   # Reactフロントエンド
│   ├── main.tsx
│   ├── App.tsx
│   ├── components/
│   │   ├── EREditor/
│   │   ├── Simulator/
│   │   └── common/
│   ├── hooks/
│   ├── stores/
│   ├── lib/
│   │   ├── db/            # DB操作
│   │   ├── crypto/        # 暗号化
│   │   └── license/       # ライセンス管理
│   ├── types/
│   └── i18n/              # 多言語対応
├── scripts/               # ビルド・リリーススクリプト
└── docs/                  # ドキュメント
```

---

## 9. 配布・ビルド要件

### 9.1 インストーラー・配布方式

| OS | 形式 | 備考 |
|----|-----|------|
| Windows | **Microsoft Store（MSIX）** | 推奨。署名不要、自動更新対応 |
| Windows | EXE (NSIS) | Store外配布用。署名なしでも可（SmartScreen警告あり） |
| macOS | 🔲 将来対応 | Apple Developer登録が必要 |

#### Microsoft Store 配布のメリット
- コード署名証明書が不要（Microsoftが署名）
- 自動更新機能が標準搭載
- 信頼性・発見性の向上
- 年間開発者登録料: 約$19（個人）

#### Microsoft Store 配布の注意点
- 審査プロセスあり（通常1-3日）
- 手数料: 15%（または12% for games）
- MSIX形式でのパッケージングが必要

### 9.2 CI/CD

```yaml
# GitHub Actions 概要
─────────────────────────────────────────
- ビルドトリガー: タグプッシュ（v*.*.*）
- ビルドマトリクス:
  - windows-latest
- 成果物: 
  - MSIX: Microsoft Store へ自動提出
  - EXE: GitHub Releases に自動アップロード
- 自動更新: 
  - Store版: Microsoft Store経由
  - 非Store版: Tauri Updater 対応
─────────────────────────────────────────
```

---

## 10. 受入基準（Acceptance Criteria）

### 10.1 必須項目

- [ ] Windows / macOS でインストーラーが生成され、正常にインストール・起動できる
- [ ] オフライン環境で全機能（編集・保存・エクスポート）が動作する
- [ ] プロジェクトの作成・編集・削除が正常に動作する
- [ ] ER図の編集（テーブル・カラム・リレーション）が既存Webアプリと同等に動作する
- [ ] 暗号化を有効にしたプロジェクトが正しく保護される
- [ ] ライセンスキー入力により有料機能がアンロックされる
- [ ] 日本語/英語の切り替えが正常に動作する

### 10.2 暗号化関連

- [ ] 暗号化を有効にして保存したデータが、同じパスフレーズで正しく復元できる
- [ ] 暗号化を無効にして保存したデータは、暗号化オフの環境で正しく読み書きできる
- [ ] エクスポート/インポート時に暗号化状態に応じて適切に処理される
- [ ] 移行フロー（平文→暗号化、暗号化解除）が正常に動作する
- [ ] 移行前にリスクが明示される

---

## 11. 決定事項一覧

### 11.1 課金・サブスクリプション

| # | 項目 | 決定内容 |
|---|------|----------|
| Q1 | 課金プラットフォーム | ✅ **LemonSqueezy** |
| Q2 | 価格設定 | ✅ Free: ¥0, Pro: ¥300/月 |
| Q3 | オフライン猶予期間 | ✅ **30日** |
| Q4 | Teamプラン | ✅ **将来対応** |

### 11.2 技術選定

| # | 項目 | 決定内容 |
|---|------|----------|
| Q5 | デスクトップフレームワーク | ✅ **Tauri** |
| Q6 | プロジェクト構成 | ✅ **単一パッケージ** |

### 11.3 機能スコープ

| # | 項目 | 決定内容 |
|---|------|----------|
| Q7 | 自動更新機能 | ✅ **MVPに含める** |
| Q8 | シミュレーター | ✅ **MVPに含める**（「シミュレーター」と表示） |
| Q9 | Excelエクスポート | ✅ **MVPに含める**（Googleスプレッドシート連携用） |

### 11.4 その他

| # | 項目 | 決定内容 |
|---|------|----------|
| Q10 | アプリケーション名 | ✅ **WaiwaiER Desktop** |
| Q11 | ライセンス形態 | ✅ **プロプライエタリ（独自EULA）** |
| Q12 | 配布方式 | ✅ **Microsoft Store（Windows）を検討** |

---

## 12. 開発スケジュール（概算）

```
Phase 1: 基盤構築（2-3週間）
─────────────────────────────────────────
- モノレポ構成セットアップ
- Tauri + React統合
- SQLite + SQLCipher統合
- 既存UIコンポーネント移植

Phase 2: コア機能実装（3-4週間）
─────────────────────────────────────────
- ローカルプロジェクト管理
- ER図エディタ機能（既存移植）
- 暗号化機能実装
- エクスポート/インポート

Phase 3: 課金システム（2週間）
─────────────────────────────────────────
- ライセンス認証機能
- 課金プラットフォーム連携
- 機能制限実装

Phase 4: 仕上げ・配布準備（2週間）
─────────────────────────────────────────
- 多言語対応
- バックアップ機能
- インストーラー生成
- CI/CD構築

合計: 約9-11週間（2-3ヶ月）
```

---

## 13. リスクと対策

| リスク | 影響度 | 対策 |
|-------|-------|------|
| SQLCipherのWASM互換性 | 中 | better-sqlite3 + ネイティブビルドをフォールバック |
| Microsoft Store審査リジェクト | 中 | ガイドライン事前確認、審査フィードバックへの迅速対応 |
| オフラインライセンス不正利用 | 中 | マシンIDバインディング、署名検証の強化 |
| パスフレーズ忘れによるデータ損失 | 高 | OSキーチェーン保存推奨、復旧不可の警告を明示 |
| LemonSqueezy決済障害 | 低 | ライセンス猶予期間（30日）で影響緩和 |

---

## 14. 次のアクション

1. **確認事項（セクション11）への回答**
2. **新規リポジトリの作成**
3. **モノレポ構成のセットアップ**
4. **既存コンポーネントの移植開始**

---

## 15. ライセンス・著作権

### 15.1 著作権表記

```
Copyright © 2025 Fuaze. All rights reserved.
```

### 15.2 エンドユーザーライセンス契約（EULA）概要

本ソフトウェアは**プロプライエタリライセンス**で提供されます。

| 項目 | 内容 |
|-----|------|
| 許諾内容 | 個人/商用利用可能（購入ライセンスに基づく） |
| 禁止事項 | リバースエンジニアリング、再配布、二次販売 |
| 保証 | 現状有姿（AS-IS）、明示的保証なし |
| 責任制限 | 購入金額を上限とする |
| 準拠法 | 日本法 |

> 正式なEULA文書は、リリース前に法的レビューを経て作成します。

---

*本ドキュメントは確定版 v1.0 です（2025-12-23更新）*
